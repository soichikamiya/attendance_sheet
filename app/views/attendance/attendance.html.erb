<table class="tg" style="undefined;table-layout: fixed; width: 1138px; margin-top:20px">
  <colgroup>
    <col style="width: 464px">
    <col style="width: 279px">
    <col style="width: 95px">
    <col style="width: 180px">
    <col style="width: 120px">
  </colgroup>
  <tr>
    <th class="tg-c3ow"><%= button_to "←", { :action => "last_month", :id => @user.id, :first_day => @first_day}, class:"button b-1" %>
      <%= @first_day.year %>年<%= @first_day.month %>月　時間管理表
      <%= button_to "→", { :action => "next_month", :id => @user.id, :first_day => @first_day}, class:"button b-2" %>
    </th>
    <th class="tg-c3ow">指定勤務時間　<%= @a_edit.strftime("%-H:%-M") %></th>
    <th class="tg-c3ow" colspan="2"><%= @l_edit.strftime("%-H:%-M") %>　基本時間　</th>
    <th class="tg-c3ow">初日　<%= @first_day.strftime("%-m/%-d") %></th>
  </tr>
  <tr>
    <td class="tg-c3ow">所属</td>
    <td class="tg-c3ow">氏名　<%= @user.name %></td>
    <td class="tg-uys7">　コード　</td>
    <td class="tg-uys7">出勤日数　<%= @user.works.where("day like?", "%#{@first_day.month}%").count %>日</td>
    <td class="tg-uys7">締め　<%= @end_day.strftime("%-m/%-d") %></td>
  </tr>
</table>
<br><br>

<%= link_to "勤怠を編集", "/attendance/edit/#{@user.id}", class:"edit_btn" %>

<table class="tg t-line" style="undefined;table-layout: fixed; width: 1137px">
  <colgroup>
    <col style="width: 83px">
    <col style="width: 83px">
    <col style="width: 62px">
    <col style="width: 62px">
    <col style="width: 167px">
    <col style="width: 52px">
    <col style="width: 52px">
    <col style="width: 21px">
    <col style="width: 123px">
    <col style="width: 227px">
    <col style="width: 100px">
    <col style="width: 105px">
  </colgroup>
  <tr>
    <th class="tg-c0l1" rowspan="2">日付</th>
    <th class="tg-c0l1" rowspan="2">曜日</th>
    <th class="tg-c0l1" colspan="3">出社</th>
    <th class="tg-c0l1" colspan="3">退社</th>
    <th class="tg-c0l1" rowspan="2">在社時間</th>
    <th class="tg-c0l1" rowspan="2">備考</th>
    <th class="tg-c0l1" rowspan="2">残業指示</th>
    <th class="tg-c0l1" rowspan="2">指示者</th>
  </tr>
  <tr>
    <th class="tg-c0l1">時</th>
    <th class="tg-c0l1">分</th>
    <th class="tg-c0l1"></th>
    <th class="tg-c0l1">時</th>
    <th class="tg-c0l1">分</th>
    <th class="tg-c0l1"></th>
  </tr>
  <br>

  <% (@first_day..@end_day).each do |d| %>
  <% d_str = d.strftime("%Y-%m-%d").to_date %>
  <tr>
    <td class="tg-dorl"><%= d.strftime("%-m/%-d") %></td>
    <td class="tg-dorl"><%= @youbi[d.wday] %></td>
    <td class="tg-dorl"><% @user.works.each {|w| %><%= w.attendance_time.hour if w.attendance_time && d_str == w.day %><%}%></td>
    <td class="tg-dorl"><% @user.works.each {|w| %><%= w.attendance_time.min if w.attendance_time && d_str == w.day %><%}%></td>
    <td class="tg-dorl">
      <% if @work_today.nil? && @work_today.attendance_time.blank? && Date.current == d || 
      @work_today.attendance_time.blank? && @work_today.leaving_time.blank? && Date.current == d %>
        <%= button_to "出勤", {action: 'create', user_id: @user.id}, {class: "btn btn-default"} %>
      <% elsif !@work_today.nil? && @work_today.leaving_time.blank? && Date.current == d %>
        <%= button_to "退勤", {action: 'create', user_id: @user.id}, {class: "btn btn-default"} %>
      <% elsif !@user.works.empty? && Date.current == d %>
        <%= link_to "勤怠を編集", "/attendance/edit/#{@user.id}" %>
      <% end %>
    </td>
    <td class="tg-dorl"><% @user.works.each {|w| %><%= w.leaving_time.hour if w.leaving_time && d_str == w.day %><%}%></td>
    <td class="tg-dorl"><% @user.works.each {|w| %><%= w.leaving_time.min if w.leaving_time && d_str == w.day %><%}%></td> 
    <td class="tg-dorl"></td>
    <td class="tg-dorl">
      <% @user.works.each {|w| %><% @w_time=(w.leaving_time - w.attendance_time) / (60 * 60) if w.leaving_time && w.attendance_time && d_str == w.day %>
      <%= @w_time.round(2) if @w_time && d_str == w.day %><%}%>
    </td>
    <td class="tg-dorl" style="word-wrap:break-word;">
      <% @user.works.each {|w| %><%= w.remarks if w.remarks && d_str == w.day %><%}%></td>
    <td class="tg-dorl"></td>
    <td class="tg-dorl"></td>
  </tr>
  <% @w_id = @user.works.where(day: d).ids[0] %>
  <% @a_all << @user.works.find(@w_id).attendance_time if !@w_id.nil? %>
  <% @l_all << @user.works.find(@w_id).leaving_time if !@w_id.nil? %>
  <% end %>

  <tr>
    <td class="tg-tjwp" colspan="2"></td>
    <td class="tg-tjwp" colspan="6"></td>
    <td class="tg-tjwp">
      <% @a_all.zip(@l_all).each { |a, b| %><% @work_all_time << (b - a)/(60 * 60) if a && b %><%}%>
      <%= @work_all_time.inject(:+).round(2) if !@work_all_time.blank? %>
    </td>
    <td class="tg-tjwp"></td>
    <td class="tg-tjwp"></td>
    <td class="tg-tjwp">所属長承認</td>
  </tr>
</table>
